---
import DashboardLayout from '../layouts/DashboardLayout.astro';
import CardStat from '../components/CardStat.astro';
import Sidebar from "../components/Sidebar.astro";
import DeleteIcon from "../assets/trash.svg"
import EditIcon from "../assets/pencil.svg"
import '../styles/dashboard.css';

import { config } from '../../config';

const users = [
  {
    id: 1,
    name: "Mar√≠a Gonz√°lez",
    email: "maria.g@example.com",
    role: "Administrador",
  },
  {
    id: 2,
    name: "Carlos Mendoza",
    email: "carlos.m@example.com",
    role: "Usuario",
  },
];

const userStats = [
  { title: 'Usuarios Totales', value: '142', subtitle: 'Registrados en el sistema', icon: 'üë•' },
  { title: 'Activos', value: '135', subtitle: 'Usuarios con acceso', icon: '‚úÖ' },
  { title: 'Inactivos', value: '5', subtitle: 'Acceso suspendido', icon: '‚è∏Ô∏è' },
  { title: 'Administradores', value: '12', subtitle: 'Con privilegios', icon: 'üëë' }
];
---

<DashboardLayout>
  <Sidebar slot="sidebar" activeSection="/users" />
  
  <main class="dashboard-main">
    <div class="flex justify-between items-center mb-6">
      <div>
        <h1 class="dashboard-title">Gesti√≥n de Usuarios</h1>
        <p class="dashboard-subtitle">Administra los usuarios del sistema y sus permisos</p>
      </div>
      <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
        + Nuevo Usuario
      </button>
    </div>

    <!-- Estad√≠sticas de usuarios -->
    <section class="stats-grid">
      {userStats.map(stat => (
        <CardStat 
          title={stat.title} 
          value={stat.value} 
          subtitle={stat.subtitle} 
          icon={stat.icon} 
        />
      ))}
    </section>

    <!-- Tabla de usuarios -->
    <section class="certificates-section mt-8">
      <div class="flex justify-between items-center mb-4">
        <h2 class="section-title">Listado de Usuarios</h2>
        <div class="relative">
          <input 
            type="text" 
            placeholder="Buscar usuario..." 
            class="pl-8 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
          >
          <span class="absolute left-2 top-3">üîç</span>
        </div>
      </div>
      
      <div class="bg-white rounded-lg shadow overflow-hidden">
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rol</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              {users.map((user) => (
                <tr class="hover:bg-gray-50">
                  <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center">
                      <div class="flex-shrink-0 h-10 w-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold">
                        {user.name.charAt(0)}
                      </div>
                      <div class="ml-4">
                        <div class="text-sm font-medium text-gray-900">{user.name}</div>
                      </div>
                    </div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{user.email}</td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <span class={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                      ${user.role === 'Administrador' ? 'bg-purple-100 text-purple-800' : 'bg-green-100 text-green-800'}`}>
                      {user.role}
                    </span>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm font-medium flex gap-x-2 items-center">
                    <button class="bg-blue-700 rounded-md p-1"><EditIcon class="text-white size-6 rounded-md"/></button>
                    <button><DeleteIcon class="text-red-600 size-6"/></button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Paginaci√≥n -->
      <div class="flex justify-between items-center mt-4">
        <div class="text-sm text-gray-500">
          Mostrando 1 al 10 de 142 usuarios
        </div>
        <div class="flex space-x-2">
          <button class="px-3 py-1 border rounded-md text-gray-700 bg-white hover:bg-gray-50">
            Anterior
          </button>
          <button class="px-3 py-1 border rounded-md text-white bg-blue-600 hover:bg-blue-700">
            1
          </button>
          <button class="px-3 py-1 border rounded-md text-gray-700 bg-white hover:bg-gray-50">
            2
          </button>
          <button class="px-3 py-1 border rounded-md text-gray-700 bg-white hover:bg-gray-50">
            Siguiente
          </button>
        </div>
      </div>
    </section>

    <!-- Modal de nuevo usuario -->
    <div id="newUserModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4">
        <div class="p-6">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-gray-800">Nuevo Usuario</h3>
            <button onclick="document.getElementById('newUserModal').classList.add('hidden')" class="text-gray-400 hover:text-gray-500">
              &times;
            </button>
          </div>
          <form id="newUserForm">
            <div class="mb-4">
              <label for="nombre" class="block text-gray-700 text-sm font-bold mb-2">Nombre</label>
              <input id="nombre" type="text" placeholder="Nombre" required
                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" />
            </div>

            <div class="mb-4">
              <label for="apellido" class="block text-gray-700 text-sm font-bold mb-2">Apellido</label>
              <input id="apellido" type="text" placeholder="Apellido" required
                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" />
            </div>

            <div class="mb-4">
              <label for="correo" class="block text-gray-700 text-sm font-bold mb-2">Correo electr√≥nico</label>
              <input id="correo" type="email" placeholder="Correo" required
                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" />
            </div>

            <div class="mb-4">
              <label for="clave" class="block text-gray-700 text-sm font-bold mb-2">Contrase√±a</label>
              <input id="clave" type="password" placeholder="Contrase√±a" required
                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" />
            </div>

            <div class="mb-4">
              <label for="rol" class="block text-gray-700 text-sm font-bold mb-2">Rol</label>
              <select id="rol" required
                class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                <option value="USER">Usuario</option>
                <option value="ADMINISTRADOR">Administrador</option>
              </select>
            </div>

            <div class="flex justify-end">
              <button type="button" onclick="document.getElementById('newUserModal').classList.add('hidden')"
                class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded mr-2">
                Cancelar
              </button>
              <button type="submit"
                class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                Guardar
              </button>
            </div>
          </form>

        </div>
      </div>
    </div>
  </main>

  <script is:inline>
    // Mostrar modal "Nuevo Usuario"
    document.addEventListener('DOMContentLoaded', function() {
      const newUserBtn = document.querySelector('main button.bg-blue-600');
      if (newUserBtn) {
        newUserBtn.addEventListener('click', function() {
          document.getElementById('newUserModal').classList.remove('hidden');
        });
      }
    });
  </script>

  <script type="module" is:inline>

    import { config } from "../../config";
import { setupPostForm } from "/src/lib/apiPost.js";

    setupPostForm({
      endpoint: config.endpoints.users.register,
      formName: 'newUser',
      getData: () => {
        const nombre = document.getElementById('nombre')?.value || '';
        const apellido = document.getElementById('apellido')?.value || '';
        const correo = document.getElementById('correo')?.value || '';
        const clave = document.getElementById('clave')?.value || '';
        const rol = document.getElementById('rol')?.value || '';

        if (!nombre || !apellido || !correo || !clave || !rol) {
          alert("Faltan campos en el formulario");
          throw new Error("Formulario incompleto");
        }

        return { nombre, apellido, correo, clave, rol };
      }
    });
</script>

</DashboardLayout>